<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>24PDC</title>

  <!-- Tab icon -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="shortcut icon" href="favicon.png">

  <style>
    :root{
      --bg: #eaeff2;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17,24,39,0.10);
      --shadow: 0 10px 28px rgba(0,0,0,0.09);
      --shadowSoft: 0 6px 16px rgba(0,0,0,0.06);

      --accent: #2d5dfc;

      --inputBg: #ffffff;
      --inputBorder: #d1d5db;

      --btnPrimary: #2d5dfc;
      --btnPrimaryHover: #1e4be0;

      --btnDark: #111827;
      --btnDarkHover: #000000;

      --pillBg: #f3f4f6;
      --pillActiveBg: #111827;
      --pillActiveText: #ffffff;

      --preBg: #0b1220;
      --preText: #4ade80;
      --preBorder: #111827;

      --divider: #eef2f7;

      --danger: #ef4444;
      --success: #22c55e;
    }

    body.dark{
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 10px 28px rgba(0,0,0,0.40);
      --shadowSoft: 0 6px 16px rgba(0,0,0,0.35);

      --accent: #60a5fa;

      --inputBg: #0b1220;
      --inputBorder: rgba(255,255,255,0.16);

      --btnPrimary: #60a5fa;
      --btnPrimaryHover: #3b82f6;

      --btnDark: #111827;
      --btnDarkHover: #0b1220;

      --pillBg: rgba(255,255,255,0.06);
      --pillActiveBg: #e5e7eb;
      --pillActiveText: #0b1220;

      --preBg: #020617;
      --preText: #86efac;
      --preBorder: rgba(255,255,255,0.12);

      --divider: rgba(255,255,255,0.08);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 40px 16px;
      display: flex;
      justify-content: center;
      color: var(--text);
      transition: background .2s, color .2s;
    }

    .layout{
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
      width: 100%;
      max-width: 1060px;
    }

    .sidebar{
      background: var(--card);
      padding: 18px;
      border-radius: 14px;
      box-shadow: var(--shadowSoft);
      height: fit-content;
      border-left: 5px solid var(--accent);
      border: 1px solid var(--border);
    }

    .sidebar h3{
      margin: 0 0 12px 0;
      font-size: 17px;
      letter-spacing: -0.2px;
      font-weight: 950;
    }

    .sideGroup{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--divider);
    }

    .sidebar button.navBtn{
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      background: var(--pillBg);
      transition: 0.2s;
      text-align: left;
      color: var(--text);
    }

    .sidebar button.navBtn.active{
      background: var(--accent);
      color: #fff;
    }

    .sidebar button.navBtn:hover{
      transform: translateY(-1px);
      filter: brightness(0.98);
    }

    .hint{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .card{
      background: var(--card);
      padding: 22px 26px;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: background .2s, border-color .2s;
    }

    .topRow{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    h2{
      font-size: 25px;
      margin: 0 0 4px 0;
      letter-spacing: -0.3px;
    }

    .subtitle{
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }

    .accent{
      width: 58px;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      margin: 10px 0 18px 0;
    }

    label{
      display: block;
      margin-top: 14px;
      font-weight: 950;
      font-size: 14px;
      color: var(--text);
      opacity: 0.95;
    }

    input, select, textarea{
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border: 1.6px solid var(--inputBorder);
      border-radius: 10px;
      font-size: 14px;
      transition: 0.2s;
      background: var(--inputBg);
      color: var(--text);
      box-sizing: border-box;
    }

    textarea{ min-height: 90px; resize: vertical; }
    input::placeholder{ color: var(--muted); opacity: 0.75; }

    input:focus, select:focus, textarea:focus{
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(45,93,252,0.14);
    }
    body.dark input:focus, body.dark select:focus, body.dark textarea:focus{
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }

    .row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }

    .sectionTitle{
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid var(--divider);
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 950;
      letter-spacing: 0.35px;
      text-transform: uppercase;
    }

    .buttons{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 20px;
    }

    button.action{
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 950;
      cursor: pointer;
      transition: 0.2s;
    }

    #gen{ background: var(--btnPrimary); color: #fff; }
    #gen:hover{ background: var(--btnPrimaryHover); }

    #copy{ background: var(--btnDark); color: #fff; }
    #copy:hover{ background: var(--btnDarkHover); }

    pre{
      background: var(--preBg);
      color: var(--preText);
      padding: 16px;
      border-radius: 14px;
      font-size: 13.5px;
      margin-top: 20px;
      min-height: 70px;
      border: 2px solid var(--preBorder);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .toggleWrap{
      margin-top: 10px;
      background: var(--pillBg);
      border-radius: 12px;
      padding: 6px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      border: 1px solid var(--border);
    }

    .pill{
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 950;
      cursor: pointer;
      user-select: none;
      text-align: center;
      background: transparent;
      color: var(--text);
      transition: 0.15s;
    }

    .pill.active{
      background: var(--pillActiveBg);
      color: var(--pillActiveText);
    }

    .pill small{
      display: block;
      font-weight: 700;
      opacity: 0.82;
      margin-top: 2px;
      font-size: 11.5px;
      line-height: 1.15;
    }

    .switchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .switchLabel{
      font-size:13px;
      color: var(--muted);
      font-weight: 850;
    }
    .switch{
      position: relative;
      width: 48px;
      height: 28px;
      background: var(--pillBg);
      border: 1px solid var(--border);
      border-radius: 999px;
      cursor: pointer;
      transition: .2s;
      flex: 0 0 auto;
    }
    .switchKnob{
      position:absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
      transition: .2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    body.dark .switchKnob{ box-shadow: 0 4px 10px rgba(0,0,0,0.35); }
    .switch.on{
      background: rgba(45,93,252,0.18);
      border-color: rgba(45,93,252,0.35);
    }
    body.dark .switch.on{
      background: rgba(96,165,250,0.18);
      border-color: rgba(96,165,250,0.35);
    }
    .switch.on .switchKnob{ left: 23px; }

    .modeSection{ display:none; }

    .steps{ margin:12px 0 0 0; padding:0; list-style:none; }
    .steps li{
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.02);
      margin-bottom:10px;
    }
    .steps b{ display:block; margin-bottom:4px; letter-spacing:-0.1px; }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background: var(--pillBg);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
    }

    .creditCard{
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.02);
    }
    .creditRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      background: var(--pillBg);
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }
    .creditRole{ font-weight: 950; letter-spacing: -0.2px; }
    .creditName{ font-weight: 900; color: var(--accent); text-align:right; }

    .fab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      border: none;
      border-radius: 999px;
      padding: 12px 14px;
      font-weight: 950;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      box-shadow: var(--shadow);
      transition: transform .15s, filter .15s;
    }
    .fab:hover{ transform: translateY(-2px); filter: brightness(0.98); }

    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 16px;
    }
    .modal{
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .modalHeader{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .modalTitle{
      font-size: 18px;
      font-weight: 950;
      margin: 0;
      letter-spacing: -0.2px;
    }
    .modalClose{
      border: none;
      background: var(--pillBg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
      cursor: pointer;
    }

    .stars{
      display:flex;
      gap: 8px;
      margin-top: 12px;
      font-size: 28px;
      user-select: none;
    }
    .star{
      cursor: pointer;
      filter: grayscale(1);
      opacity: 0.65;
      transition: transform .1s, opacity .1s, filter .1s;
    }
    .star.active{ filter: grayscale(0); opacity: 1; }
    .star:hover{ transform: translateY(-1px); }

    .modalBtns{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btnSmall{
      border:none;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 950;
      cursor: pointer;
      transition: .15s;
    }
    .btnSend{ background: var(--btnPrimary); color:#fff; }
    .btnSend:hover{ background: var(--btnPrimaryHover); }
    .btnCancel{ background: var(--pillBg); color: var(--text); border: 1px solid var(--border); }
    .btnCancel:hover{ filter: brightness(0.98); }

    .toast{
      position: fixed;
      right: 18px;
      bottom: 70px;
      z-index: 10001;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadowSoft);
      display: none;
      max-width: 340px;
      font-size: 13px;
      font-weight: 850;
    }
    .toast.ok{ border-left: 5px solid var(--success); }
    .toast.err{ border-left: 5px solid var(--danger); }

    @media (max-width: 820px){
      .layout{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 1fr; }
      .buttons{ grid-template-columns: 1fr; }
      .toast{ right: 12px; left: 12px; max-width: unset; }
      .fab{ right: 12px; bottom: 12px; }
    }
  </style>
</head>

<body>
  <div class="layout">
    <div class="sidebar">
      <h3>Menu</h3>
      <button id="genPageBtn" class="navBtn active">Generator</button>
      <button id="helpPageBtn" class="navBtn">Instructions</button>
      <button id="creditsPageBtn" class="navBtn">Credits</button>

      <div class="sideGroup">
        <h3 style="margin:0 0 10px 0; font-size:15px;">PDC Type</h3>
        <button id="atc24Btn" class="navBtn active">ATC24 Standard <span style="font-weight:800;opacity:.85;">(Default)</span></button>
        <button id="vatusaBtn" class="navBtn">VATUSA Format</button>
        <div class="hint">Fields change based on the format.</div>
      </div>

      <div class="sideGroup">
        <div class="switchRow">
          <div>
            <div style="font-weight:950;font-size:14px;">Theme</div>
            <div class="switchLabel">Light / Dark</div>
          </div>
          <div id="themeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0">
            <div class="switchKnob"></div>
          </div>
        </div>
        <div class="hint">Saved automatically for next time.</div>
      </div>
    </div>

    <div class="card">
      <div id="generatorPage">
        <div class="topRow">
          <div>
            <h2>PDC Generator</h2>
            <p class="subtitle">Fast PDC builder </p>
          </div>
        </div>
        <div class="accent"></div>

        <label>Callsign</label>
        <input id="callsign" placeholder="WJA550L / DAL125 / AAL3" />

        <label>Route (if N/A ‚Üí GPS DCT)</label>
        <input id="route" placeholder="N/A or GPS Direct" />

        <div id="atc24Section" class="modeSection" style="display:block;">
          <div class="sectionTitle">ATC24 Standard Fields</div>

          <div class="row">
            <div>
              <label>Destination (Arrival)</label>
              <input id="atc24_dest" placeholder="IPPH" />
            </div>
            <div>
              <label>INTL FL (optional)</label>
              <input id="atc24_intlFL" placeholder="020" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>CLIMB FL</label>
              <input id="atc24_climbFL" placeholder="040" />
            </div>
            <div>
              <label>RWY</label>
              <input id="atc24_runway" placeholder="13" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>DEP FREQ</label>
              <input id="atc24_depFreq" placeholder="132.300" />
            </div>
            <div>
              <label>QNH (optional)</label>
              <input id="atc24_qnh" placeholder="1013" />
            </div>
          </div>

          <label>REMAIN TWR UNTIL (optional)</label>
          <input id="atc24_remainTwrUntil" placeholder="010" />

          <label>End Line / Readback</label>
          <select id="atc24_endMode">
            <option value="DO_NOT_READBACK" selected>DO NOT READBACK PDC (default)</option>
            <option value="READBACK_SQUAWK">READBACK SQUAWK</option>
            <option value="READBACK_FULL">READBACK FULL PDC</option>
            <option value="NONE">None</option>
          </select>

          <label>Extra End Text (optional)</label>
          <input id="atc24_extraEnd" placeholder="e.g. CONTACT GND WHEN READY / REMAIN VFR / etc." />
        </div>

        <div id="vatusaSection" class="modeSection">
          <div class="sectionTitle">VATUSA Fields</div>

          <div class="row">
            <div>
              <label>Departure ICAO</label>
              <input id="vat_dep" placeholder="IFRD" />
            </div>
            <div>
              <label>Destination ICAO</label>
              <input id="vat_dest" placeholder="IPPH" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Equipment</label>
              <input id="vat_equip" placeholder="B738/L" />
            </div>
            <div>
              <label>Filed Altitude</label>
              <input id="vat_filedAlt" placeholder="FL350" />
            </div>
          </div>

          <label>SID (optional ‚Äî leave blank for GPS DCT)</label>
          <input id="vat_sid" placeholder="SUMMA2 (or leave blank)" />

          <label>Initial Altitude (optional)</label>
          <input id="vat_initial" placeholder="FL050" />

          <div class="row">
            <div>
              <label>Departure Frequency</label>
              <input id="vat_dpFreq" placeholder="124.850" />
            </div>
            <div>
              <label>Ground Frequency</label>
              <input id="vat_gndFreq" placeholder="121.900" />
            </div>
          </div>

          <label>Contact ground for</label>
          <div class="toggleWrap" role="tablist" aria-label="Ground contact for">
            <div id="pillPush" class="pill active" role="tab" aria-selected="true" tabindex="0">
              PUSH
              <small>CTC ground for push</small>
            </div>
            <div id="pillTaxi" class="pill" role="tab" aria-selected="false" tabindex="0">
              TAXI
              <small>CTC ground for taxi</small>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button id="gen" class="action" type="button">Generate</button>
          <button id="copy" class="action" type="button">Copy Output</button>
        </div>

        <pre id="out"></pre>
      </div>

      <div id="instructionsPage" style="display:none;">
        <div class="topRow">
          <div>
            <h2>Instructions</h2>
            <p class="subtitle">Pick a format, fill the fields, generate, then copy.</p>
          </div>
        </div>
        <div class="accent"></div>

        <ul class="steps">
          <li><b>1) Pick a PDC Type</b> Use the sidebar: <span class="chip">ATC24 Standard</span> or <span class="chip">VATUSA</span>.</li>
          <li><b>2) Fill the fields</b> Callsign + Route, then the format-specific fields.</li>
          <li><b>3) Generate</b> Squawk uses <span class="chip">0‚Äì7 only</span> and won‚Äôt repeat in the same tab session.</li>
          <li><b>4) Copy</b> Copy wraps output in backticks for Discord.</li>
          <li><b>VATUSA SID</b> Optional ‚Äî leave blank (or N/A) for GPS DCT traffic.</li>
        </ul>
      </div>

      <div id="creditsPage" style="display:none;">
        <div class="topRow">
          <div>
            <h2>Credits</h2>
            <p class="subtitle">The people who helped build & test this tool.</p>
          </div>
        </div>
        <div class="accent"></div>

        <div class="creditCard">
          <div class="creditRow">
            <div class="creditRole">Head Developer</div>
            <div class="creditName">polandball</div>
          </div>

          <div class="creditRow">
            <div class="creditRole">VATUSA Idea & Testing</div>
            <div class="creditName">YoItsAni</div>
          </div>

          <div class="creditRow" style="margin-bottom:0;">
            <div class="creditRole">Testers</div>
            <div class="creditName">k4rian, db25</div>
          </div>

          <div class="hint" style="margin-top:10px;">
            If you helped and want to be listed, DM polandball.
          </div>
        </div>
      </div>
    </div>
  </div>

  <button id="rateBtn" class="fab" type="button">Rate (1‚Äì5)</button>

  <div id="rateOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rateTitle">
      <div class="modalHeader">
        <div>
          <p id="rateTitle" class="modalTitle">Rate this tool</p>
          <div class="hint" style="margin-top:4px;">This sends feedback privately to the developer.</div>
        </div>
        <button id="rateClose" class="modalClose" type="button">Close</button>
      </div>

      <div class="stars" id="starsRow" aria-label="Rating stars">
        <span class="star" data-v="1">‚≠ê</span>
        <span class="star" data-v="2">‚≠ê</span>
        <span class="star" data-v="3">‚≠ê</span>
        <span class="star" data-v="4">‚≠ê</span>
        <span class="star" data-v="5">‚≠ê</span>
      </div>

      <label style="margin-top:10px;">Comment (optional)</label>
      <textarea id="rateComment" placeholder="What should be improved / added?"></textarea>

      <div class="modalBtns">
        <button id="rateSend" class="btnSmall btnSend" type="button">Send</button>
        <button id="rateCancel" class="btnSmall btnCancel" type="button">Cancel</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        Note: One vote per browser (to prevent spam).
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    // ======================
    // Pages
    // ======================
    function setPage(page){
      const gen = $("generatorPage");
      const help = $("instructionsPage");
      const cred = $("creditsPage");

      $("genPageBtn").classList.toggle("active", page === "gen");
      $("helpPageBtn").classList.toggle("active", page === "help");
      $("creditsPageBtn").classList.toggle("active", page === "credits");

      gen.style.display = (page === "gen") ? "block" : "none";
      help.style.display = (page === "help") ? "block" : "none";
      cred.style.display = (page === "credits") ? "block" : "none";
    }
    $("genPageBtn").onclick = () => setPage("gen");
    $("helpPageBtn").onclick = () => setPage("help");
    $("creditsPageBtn").onclick = () => setPage("credits");

    // ======================
    // Mode Switcher
    // ======================
    let pdcMode = "ATC24";
    function setMode(mode){
      pdcMode = mode;
      $("atc24Btn").classList.toggle("active", mode === "ATC24");
      $("vatusaBtn").classList.toggle("active", mode === "VATUSA");

      $("atc24Section").style.display = (mode === "ATC24") ? "block" : "none";
      $("vatusaSection").style.display = (mode === "VATUSA") ? "block" : "none";
    }
    $("atc24Btn").onclick = () => setMode("ATC24");
    $("vatusaBtn").onclick = () => setMode("VATUSA");

    // ======================
    // Theme Toggle
    // ======================
    const THEME_KEY = "pdc_theme";
    function applyTheme(theme){
      document.body.classList.toggle("dark", theme === "dark");
      const sw = $("themeSwitch");
      const isDark = theme === "dark";
      sw.classList.toggle("on", isDark);
      sw.setAttribute("aria-checked", isDark ? "true" : "false");
      localStorage.setItem(THEME_KEY, theme);
    }
    function toggleTheme(){
      const nowDark = document.body.classList.contains("dark");
      applyTheme(nowDark ? "light" : "dark");
    }
    $("themeSwitch").onclick = toggleTheme;
    $("themeSwitch").onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") toggleTheme(); };
    applyTheme(localStorage.getItem(THEME_KEY) || "light");

    // ======================
    // VATUSA Push/Taxi Toggle
    // ======================
    let groundContactMode = "PUSH";
    function setVatusaToggle(mode){
      groundContactMode = mode;
      $("pillPush").classList.toggle("active", mode === "PUSH");
      $("pillTaxi").classList.toggle("active", mode === "TAXI");
      $("pillPush").setAttribute("aria-selected", mode === "PUSH" ? "true" : "false");
      $("pillTaxi").setAttribute("aria-selected", mode === "TAXI" ? "true" : "false");
    }
    $("pillPush").onclick = () => setVatusaToggle("PUSH");
    $("pillTaxi").onclick = () => setVatusaToggle("TAXI");
    $("pillPush").onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") setVatusaToggle("PUSH"); };
    $("pillTaxi").onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") setVatusaToggle("TAXI"); };

    // ======================
    // Helpers
    // ======================
    function normalizeRoute(route){
      const r = String(route || "").trim().toUpperCase();
      if (!r || r === "N/A" || r === "NA") return "GPS DCT";
      return r;
    }

    function toFL(value){
      const v = String(value ?? "").trim().toUpperCase();
      if (!v) return "";
      if (v.startsWith("FL")) return v;
      const digits = v.replace(/\D/g, "").padStart(3, "0").slice(-3);
      return `FL${digits}`;
    }

    // Squawk: digits 0-7 only (no 8/9) + unique per tab session
    const USED_KEY = "pdc_used_squawks_no89";
    function getUsedSet(){
      try{ return new Set(JSON.parse(sessionStorage.getItem(USED_KEY) || "[]")); }
      catch{ return new Set(); }
    }
    function saveUsedSet(set){
      sessionStorage.setItem(USED_KEY, JSON.stringify([...set]));
    }
    function generateUniqueSquawk(){
      const used = getUsedSet();
      for (let attempts = 0; attempts < 5000; attempts++){
        let code = "";
        for (let i = 0; i < 4; i++) code += String(Math.floor(Math.random() * 8));
        if (used.has(code)) continue;
        used.add(code);
        saveUsedSet(used);
        return code;
      }
      throw new Error("Could not generate a unique squawk (session exhausted).");
    }

    // ======================
    // Generate + Copy
    // ======================
    $("gen").onclick = () => {
      const callsign = $("callsign").value.trim().toUpperCase();
      if (!callsign){ $("out").textContent = "Error: Callsign is required."; return; }

      const route = normalizeRoute($("route").value);
      const squawk = generateUniqueSquawk();

      if (pdcMode === "ATC24"){
        const dest = $("atc24_dest").value.trim().toUpperCase();
        const intlFL = toFL($("atc24_intlFL").value);
        const climbFL = toFL($("atc24_climbFL").value);
        const runway = $("atc24_runway").value.trim();
        const depFreq = $("atc24_depFreq").value.trim();
        const qnh = $("atc24_qnh").value.trim();
        const remainTwrUntil = toFL($("atc24_remainTwrUntil").value);

        const endMode = $("atc24_endMode").value;
        const extraEnd = $("atc24_extraEnd").value.trim().toUpperCase();

        if (!dest)    { $("out").textContent = "Error: Destination is required for ATC24 Standard."; return; }
        if (!climbFL) { $("out").textContent = "Error: CLIMB FL is required for ATC24 Standard."; return; }
        if (!runway)  { $("out").textContent = "Error: RWY is required for ATC24 Standard."; return; }
        if (!depFreq) { $("out").textContent = "Error: DEP FREQ is required for ATC24 Standard."; return; }

        const parts = [];
        parts.push(callsign);
        parts.push(`CLEARED TO ${dest}`);
        parts.push(`VIA ${route}`);
        if (intlFL) parts.push(`INTL ${intlFL}`);
        parts.push(`CLIMB ${climbFL}`);
        parts.push(`RWY ${runway}`);
        parts.push(`DEP FREQ ${depFreq}`);
        if (qnh) parts.push(`QNH ${qnh}`);
        if (remainTwrUntil) parts.push(`REMAIN TWR UNTIL ${remainTwrUntil}`);
        parts.push(`SQUAWK ${squawk}`);

        if (endMode === "DO_NOT_READBACK") parts.push("DO NOT READBACK PDC");
        else if (endMode === "READBACK_SQUAWK") parts.push("READBACK SQUAWK");
        else if (endMode === "READBACK_FULL") parts.push("READBACK FULL PDC");
        if (extraEnd) parts.push(extraEnd);

        $("out").textContent = parts.join(" | ");
        return;
      }

      // VATUSA
      const dep = $("vat_dep").value.trim().toUpperCase();
      const dest = $("vat_dest").value.trim().toUpperCase();
      const equip = $("vat_equip").value.trim().toUpperCase();
      const filedAlt = toFL($("vat_filedAlt").value);

      // SID optional
      const sidRaw = $("vat_sid").value.trim().toUpperCase();
      const sidClean = (!sidRaw || sidRaw === "N/A" || sidRaw === "NA") ? "" : sidRaw;

      const initial = toFL($("vat_initial").value);
      const dpFreq = $("vat_dpFreq").value.trim();
      const gndFreq = $("vat_gndFreq").value.trim();

      if (!dep || !dest || !equip || !filedAlt || !dpFreq || !gndFreq){
        $("out").textContent = "Error: For VATUSA, fill Departure, Destination, Equipment, Filed Altitude, DP Freq, and Ground Freq.";
        return;
      }

      const contactPart =
        (groundContactMode === "PUSH")
          ? `CTC ${gndFreq} FOR PUSH`
          : `CTC ${gndFreq} FOR TAXI`;

      const maintainPart = initial ? ` EXCEPT MAINTAIN ${initial}` : "";

      const remarks =
        sidClean
          ? `CLEARED ${sidClean} DEPARTURE CLIMB VIA SID${maintainPart} EXP ${filedAlt} 10 MIN AFT DP, DPFRQ ${dpFreq} ${contactPart}`
          : `CLEARED TO ${dest} VIA ROUTE${maintainPart} EXP ${filedAlt} 10 MIN AFT DP, DPFRQ ${dpFreq} ${contactPart}`;

      $("out").textContent =
        `ACARS: PDC | CALLSIGN: ${callsign}` +
        ` | EQUIPMENT: ${equip}` +
        ` | DEPARTURE: ${dep}` +
        ` | DESTINATION: ${dest}` +
        ` | ROUTE: ${route}` +
        ` | ALTITUDE: ${filedAlt}` +
        ` | SQUAWK: ${squawk}` +
        ` | REMARKS: ${remarks}`;
    };

    $("copy").onclick = async () => {
      const text = $("out").textContent.trim();
      if(!text) return;
      await navigator.clipboard.writeText("`" + text + "`");
    };

    // ======================
    // Toast
    // ======================
    let toastTimer = null;
    function showToast(msg, type){
      const t = $("toast");
      t.className = "toast " + (type === "err" ? "err" : "ok");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { t.style.display = "none"; }, 3800);
    }


    const RATE_ENDPOINT = "https://24pdc.emersburgh2028.workers.dev";

    const RATE_KEY = "pdc_has_rated";
    let selectedRating = 0;

    function openRate(){
      $("rateOverlay").style.display = "flex";
      $("rateOverlay").setAttribute("aria-hidden", "false");
    }
    function closeRate(){
      $("rateOverlay").style.display = "none";
      $("rateOverlay").setAttribute("aria-hidden", "true");
    }
    function paintStars(n){
      [...document.querySelectorAll(".star")].forEach(st => {
        const v = Number(st.dataset.v);
        st.classList.toggle("active", v <= n);
      });
    }

    $("rateBtn").onclick = () => {
      if (localStorage.getItem(RATE_KEY) === "1"){
        showToast("You already rated from this browser. Thanks again ‚ù§Ô∏è", "ok");
        return;
      }
      selectedRating = 0;
      paintStars(0);
      $("rateComment").value = "";
      openRate();
    };

    $("rateClose").onclick = closeRate;
    $("rateCancel").onclick = closeRate;

    $("rateOverlay").addEventListener("click", (e) => {
      if (e.target === $("rateOverlay")) closeRate();
    });

    document.querySelectorAll(".star").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = Number(star.dataset.v);
        paintStars(selectedRating);
      });
    });

    $("rateSend").onclick = async () => {
      if (localStorage.getItem(RATE_KEY) === "1"){
        showToast("You already rated from this browser. Thanks again ‚ù§Ô∏è", "ok");
        closeRate();
        return;
      }
      if (!selectedRating){
        showToast("Pick a star rating first üôÇ", "err");
        return;
      }

      const comment = $("rateComment").value.trim();

      try{
        const res = await fetch(RATE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            rating: selectedRating,
            comment: comment,
            page: location.href
          })
        });

        if (!res.ok) throw new Error("Endpoint failed");

        localStorage.setItem(RATE_KEY, "1");
        showToast("Thanks! Rating sent ‚úÖ", "ok");
        closeRate();
      } catch (err){
        showToast("Couldn‚Äôt send rating (endpoint error). Try again later.", "err");
      }
    };
  </script>
</body>
</html>
